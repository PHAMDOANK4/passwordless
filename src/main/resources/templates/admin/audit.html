<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{admin/layout :: head('Audit Logs')}"></head>
<body>
    <nav th:replace="~{admin/layout :: sidebar('audit')}"></nav>
    <div th:replace="~{admin/layout :: toasts}"></div>

    <div class="main">
        <div class="topbar">
            <h1>Audit Logs</h1>
            <div class="topbar-actions">
                <button class="btn btn-outline btn-sm" onclick="loadLogs()">‚Üª Refresh</button>
            </div>
        </div>
        <div class="content">
            <!-- Filters -->
            <div class="card" style="margin-bottom:24px;">
                <div class="card-body" style="padding:16px 24px;">
                    <div style="display:flex;align-items:end;gap:16px;flex-wrap:wrap;">
                        <div class="form-group" style="margin:0;min-width:150px;">
                            <label>Event Type</label>
                            <select class="form-control" id="filterEvent" onchange="resetAndLoad()">
                                <option value="">All Events</option>
                                <option value="AUTHENTICATION">Authentication</option>
                                <option value="API_REQUEST">API Request</option>
                                <option value="RATE_LIMIT_EXCEEDED">Rate Limit</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0;min-width:140px;">
                            <label>Status</label>
                            <select class="form-control" id="filterStatus" onchange="resetAndLoad()">
                                <option value="">All</option>
                                <option value="success">Success</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0;min-width:140px;">
                            <label>Sort</label>
                            <select class="form-control" id="sortDirection" onchange="resetAndLoad()">
                                <option value="DESC">Newest First</option>
                                <option value="ASC">Oldest First</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin:0;min-width:80px;">
                            <label>Page Size</label>
                            <select class="form-control" id="pageSize" onchange="resetAndLoad()">
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <span style="font-size:13px;color:var(--text-light);padding-bottom:4px;" id="logTotal"></span>
                    </div>
                </div>
            </div>

            <!-- Logs Table -->
            <div class="card">
                <div class="card-header">
                    <h3>Activity Log</h3>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button class="btn btn-outline btn-sm" onclick="prevPage()" id="prevBtn" disabled>‚Üê Prev</button>
                        <span style="font-size:13px;color:var(--text-light)" id="pageInfo"></span>
                        <button class="btn btn-outline btn-sm" onclick="nextPage()" id="nextBtn" disabled>Next ‚Üí</button>
                    </div>
                </div>
                <div class="card-body" style="padding:0">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Event Type</th>
                                    <th>App</th>
                                    <th>Method</th>
                                    <th>Endpoint</th>
                                    <th>IP Address</th>
                                    <th>Status</th>
                                    <th>Error</th>
                                </tr>
                            </thead>
                            <tbody id="logsTable">
                                <tr><td colspan="8" class="loading"><span class="spinner"></span>Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Detail Modal -->
    <div class="modal-backdrop" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Log Entry Details</h3>
                <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
            </div>
            <div class="modal-body" id="detailContent"></div>
        </div>
    </div>

    <script>
        let currentPage = 0;
        let totalPages = 0;

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function closeModal(id) { document.getElementById(id).classList.remove('show'); }

        function formatTime(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        function resetAndLoad() {
            currentPage = 0;
            loadLogs();
        }

        function prevPage() { if (currentPage > 0) { currentPage--; loadLogs(); } }
        function nextPage() { if (currentPage < totalPages - 1) { currentPage++; loadLogs(); } }

        async function loadLogs() {
            const eventType = document.getElementById('filterEvent').value;
            const direction = document.getElementById('sortDirection').value;
            const size = document.getElementById('pageSize').value;
            const tbody = document.getElementById('logsTable');
            tbody.innerHTML = '<tr><td colspan="8" class="loading"><span class="spinner"></span>Loading...</td></tr>';

            try {
                let url;
                if (eventType) {
                    url = `/apps/v1/audit/logs/event/${eventType}?page=${currentPage}&size=${size}`;
                } else {
                    url = `/apps/v1/audit/logs?page=${currentPage}&size=${size}&sortBy=createdAt&direction=${direction}`;
                }

                const res = await fetch(url);
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();
                const logs = data.content || [];
                totalPages = data.totalPages || 0;

                document.getElementById('logTotal').textContent = `${data.totalElements || 0} total records`;
                document.getElementById('pageInfo').textContent = totalPages > 0 ? `Page ${currentPage + 1} of ${totalPages}` : '';
                document.getElementById('prevBtn').disabled = currentPage === 0;
                document.getElementById('nextBtn').disabled = currentPage >= totalPages - 1;

                // Apply client-side status filter
                const statusFilter = document.getElementById('filterStatus').value;
                let filteredLogs = logs;
                if (statusFilter === 'success') filteredLogs = logs.filter(l => l.success);
                if (statusFilter === 'failed') filteredLogs = logs.filter(l => !l.success);

                if (filteredLogs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">üìã</div><h4>No audit logs found</h4><p>Activity will appear here as it happens</p></div></td></tr>';
                    return;
                }

                tbody.innerHTML = filteredLogs.map(l => `
                    <tr style="cursor:pointer" onclick='viewLog(${JSON.stringify(l).replace(/'/g, "\\'")})'>
                        <td style="font-size:12px;color:var(--text-light);white-space:nowrap;">${formatTime(l.createdAt)}</td>
                        <td><span class="badge ${getEventBadge(l.eventType)}">${l.eventType || '-'}</span></td>
                        <td style="font-size:13px">${l.appName || '-'}</td>
                        <td><span class="badge badge-secondary">${l.httpMethod || '-'}</span></td>
                        <td style="font-size:12px;font-family:monospace;max-width:200px;overflow:hidden;text-overflow:ellipsis;">${l.endpoint || '-'}</td>
                        <td style="font-size:13px">${l.ipAddress || '-'}</td>
                        <td>${l.success ? '<span class="badge badge-success">Success</span>' : '<span class="badge badge-danger">Failed</span>'}</td>
                        <td style="font-size:12px;color:var(--danger);max-width:150px;overflow:hidden;text-overflow:ellipsis;">${l.errorMessage || ''}</td>
                    </tr>
                `).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--danger);">Failed to load logs</td></tr>';
                showToast('Failed to load audit logs', 'error');
            }
        }

        function getEventBadge(type) {
            switch(type) {
                case 'AUTHENTICATION': return 'badge-info';
                case 'API_REQUEST': return 'badge-secondary';
                case 'RATE_LIMIT_EXCEEDED': return 'badge-warning';
                default: return 'badge-secondary';
            }
        }

        function viewLog(log) {
            document.getElementById('detailContent').innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div><label style="font-size:12px;color:var(--text-light)">Event Type</label><p><span class="badge ${getEventBadge(log.eventType)}">${log.eventType || '-'}</span></p></div>
                    <div><label style="font-size:12px;color:var(--text-light)">Status</label><p>${log.success ? '<span class="badge badge-success">Success</span>' : '<span class="badge badge-danger">Failed</span>'}</p></div>
                    <div><label style="font-size:12px;color:var(--text-light)">Timestamp</label><p>${formatTime(log.createdAt)}</p></div>
                    <div><label style="font-size:12px;color:var(--text-light)">IP Address</label><p>${log.ipAddress || '-'}</p></div>
                    <div><label style="font-size:12px;color:var(--text-light)">HTTP Method</label><p><span class="badge badge-secondary">${log.httpMethod || '-'}</span></p></div>
                    <div><label style="font-size:12px;color:var(--text-light)">Endpoint</label><p style="font-family:monospace;font-size:13px;word-break:break-all">${log.endpoint || '-'}</p></div>
                    <div><label style="font-size:12px;color:var(--text-light)">App Name</label><p>${log.appName || '-'}</p></div>
                    <div><label style="font-size:12px;color:var(--text-light)">App ID</label><p style="font-size:13px">${log.appId || '-'}</p></div>
                </div>
                ${log.errorMessage ? `<div style="margin-top:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:12px;"><label style="font-size:12px;color:#991b1b;font-weight:600">Error Message</label><p style="color:#991b1b;font-size:14px;margin-top:4px;">${log.errorMessage}</p></div>` : ''}
                ${log.details ? `<div style="margin-top:16px"><label style="font-size:12px;color:var(--text-light)">Details</label><pre style="background:#f8fafc;padding:12px;border-radius:8px;font-size:12px;overflow:auto;max-height:200px;">${JSON.stringify(JSON.parse(log.details || '{}'), null, 2)}</pre></div>` : ''}
                ${log.userEmail ? `<div style="margin-top:16px"><label style="font-size:12px;color:var(--text-light)">User</label><p>${log.userEmail}</p></div>` : ''}
            `;
            document.getElementById('detailModal').classList.add('show');
        }

        loadLogs();
    </script>
</body>
</html>
